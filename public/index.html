<!DOCTYPE html>
<html lang="vi" data-bs-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra cứu & Bán Bill — CheckBill Pro</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />

  <!-- Boxicons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

  <!-- App styles -->
  <link rel="stylesheet" href="style.css" />

  <meta name="description" content="Tra cứu hóa đơn điện hàng loạt, quản lý KHO, bán bill. Giao tiếp duy nhất với CheckBill Pro (bill.7ty.vn)." />
</head>
<body class="bg-body-tertiary">

  <!-- Login modal (shown if auth required) -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-sm">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="bx bx-log-in-circle"></i> Đăng nhập</h5>
        </div>
        <div class="modal-body">
          <div id="loginError" class="alert alert-danger d-none"></div>
          <form id="loginForm" class="needs-validation" novalidate>
            <div class="mb-2">
              <label for="username" class="form-label">Tên đăng nhập</label>
              <input id="username" class="form-control" required />
            </div>
            <div class="mb-2">
              <label for="password" class="form-label">Mật khẩu</label>
              <input id="password" type="password" class="form-control" required />
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="rememberMeCheckbox" />
              <label class="form-check-label" for="rememberMeCheckbox">Ghi nhớ đăng nhập</label>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary d-flex align-items-center justify-content-center">
                <span class="btn-text">Đăng nhập</span>
                <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
              </button>
            </div>
            <p class="text-muted small mt-2 text-center">Chế độ dev: bật SKIP_AUTH=true để bỏ qua đăng nhập</p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <nav id="appHeader" class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top d-none">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">
        <i class="bx bxs-bolt-circle text-primary"></i> Tra cứu & Bán Bill
      </a>

      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="usernameDisplay" class="small text-muted">—</span>
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm" id="themeBtn" data-bs-toggle="dropdown">
            <i class="bx bx-palette"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" data-bs-theme-value="light">Sáng</a></li>
            <li><a class="dropdown-item" href="#" data-bs-theme-value="dark">Tối</a></li>
            <li><a class="dropdown-item active" href="#" data-bs-theme-value="auto">Tự động</a></li>
          </ul>
        </div>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm d-flex align-items-center">
          <span class="btn-text"><i class="bx bx-log-out"></i> Thoát</span>
          <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main app -->
  <main id="appContent" class="container-fluid main-container d-none" style="padding-top:78px;">
    <div class="row g-3">

      <!-- Controls area -->
      <div class="col-12 controls-area">
        <div class="row g-3">

          <!-- Column 1: Lookup -->
          <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header fw-semibold"><i class="bx bx-search-alt"></i> Tra cứu hóa đơn</div>
              <div class="card-body d-flex flex-column">
                <label for="provider" class="form-label small">Nhà cung cấp (SKU)</label>
                <select id="provider" class="form-select form-select-sm mb-2">
                  <option value="00906815">Điện lực miền Nam (00906815)</option>
                  <option value="00906819">Điện lực miền Bắc (00906819)</option>
                  <option value="00906818">Điện EVNHCMC (00906818)</option>
                  <option value="00906820">Điện EVN Hà Nội (00906820)</option>
                  <option value="00906817">Điện An Giang (00906817)</option>
                </select>

                <label for="accounts" class="form-label small">Nhập mã hợp đồng (mỗi dòng 1 mã)</label>
                <textarea id="accounts" class="form-control form-control-sm mb-2" rows="5" placeholder="Ví dụ: PB02020047317"></textarea>

                <div class="d-flex gap-2 mb-2">
                  <button id="filterDupBtn" class="btn btn-outline-secondary btn-sm flex-grow-1"><i class="bx bx-filter-alt"></i> Lọc trùng</button>
                  <button id="lookupBulkBtn" class="btn btn-primary btn-sm flex-grow-2 d-flex align-items-center justify-content-center">
                    <span class="btn-text"><i class="bx bx-search-alt"></i> Tra cứu</span>
                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
                  </button>
                </div>

                <small class="text-muted">Lưu ý: Hệ thống gọi duy nhất CheckBill Pro; không gửi quá 10 req/s</small>
              </div>
            </div>
          </div>

          <!-- Column 2: KHO -->
          <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header fw-semibold"><i class="bx bx-archive"></i> KHO</div>
              <div class="card-body d-flex flex-column">
                <div class="d-grid gap-2 mb-2">
                  <button id="khoImportBtn" class="btn btn-outline-primary btn-sm"><i class="bx bx-import"></i> Nhập vào KHO</button>
                  <button id="khoRemoveBtn" class="btn btn-outline-danger btn-sm"><i class="bx bxs-trash"></i> Xóa khỏi KHO</button>
                </div>
                <hr />
                <div class="d-grid mb-2">
                  <button id="khoListBtn" class="btn btn-primary btn-sm"><i class="bx bx-box"></i> Mở KHO</button>
                </div>
                <div class="mt-auto"></div>
              </div>
            </div>
          </div>

          <!-- Column 3: Employees -->
          <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header fw-semibold"><i class="bx bxs-user-detail"></i> Nhân viên</div>
              <div class="card-body d-flex flex-column">
                <div class="input-group input-group-sm mb-2">
                  <input id="employeeSearchInput" class="form-control" placeholder="Tìm nhân viên..." />
                  <button id="employeeSearchBtn" class="btn btn-outline-secondary"><i class="bx bx-search"></i></button>
                </div>
                <select id="employeeSelect" class="form-select form-select-sm mb-2" size="5"></select>
                <div class="d-flex gap-2">
                  <button id="addEmployeeBtn" class="btn btn-success btn-sm admin-only d-none"><i class="bx bx-user-plus"></i></button>
                  <button id="editEmployeeBtn" class="btn btn-warning btn-sm admin-only d-none"><i class="bx bx-edit"></i></button>
                  <button id="deleteEmployeeBtn" class="btn btn-danger btn-sm admin-only d-none"><i class="bx bx-trash"></i></button>
                </div>
                <hr />
                <button id="viewNotesBtn" class="btn btn-outline-secondary btn-sm mt-auto"><i class="bx bx-note"></i> Ghi chú NV</button>
              </div>
            </div>
          </div>

          <!-- Column 4: Khách hàng & Bán hàng -->
          <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header fw-semibold"><i class="bx bx-user-circle"></i> Khách Hàng Thẻ & Bán</div>
              <div class="card-body d-flex flex-column">
                <div class="d-flex gap-1 mb-2">
                  <button id="memberAddBtn" class="btn btn-outline-success btn-sm admin-only d-none"><i class="bx bx-user-plus"></i> Thêm</button>
                  <button id="memberEditBtn" class="btn btn-outline-warning btn-sm admin-only d-none"><i class="bx bx-edit"></i> Sửa</button>
                  <button id="memberViewBtn" class="btn btn-outline-info btn-sm"><i class="bx bx-list-ul"></i> Danh sách</button>
                </div>

                <input id="memberSearch" class="form-control form-control-sm mb-2" placeholder="Tìm tên KHT (Enter)" />
                <select id="memberSelect" class="form-select form-select-sm mb-3"></select>

                <label class="form-label small">Lọc Bill KHO (Từ → Đến, VNĐ)</label>
                <div class="input-group input-group-sm mb-2">
                  <span class="input-group-text">Từ</span>
                  <input id="targetFrom" class="form-control" type="number" placeholder="Số tiền" />
                  <span class="input-group-text">Đến</span>
                  <input id="targetTo" class="form-control" type="number" placeholder="Số tiền" />
                  <button id="pickBtn" class="btn btn-info"><i class="bx bx-filter"></i></button>
                </div>

                <div class="d-grid gap-2 mt-auto">
                  <button id="sellBtn" class="btn btn-success fw-bold d-flex align-items-center justify-content-center">
                    <span class="btn-text"><i class="bx bxs-check-circle"></i> Bán</span>
                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
                  </button>
                  <button id="historyBtn" class="btn btn-secondary btn-sm"><i class="bx bx-history"></i> Lịch sử giao dịch</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Results area -->
      <div class="col-12 main-content">
        <div id="status" class="alert alert-info d-none" role="alert"></div>

        <div class="card shadow-sm mb-3">
          <div class="card-body result-controls-card">
            <div class="row g-2 align-items-center mb-3">
              <div class="col-md-7 col-lg-8">
                <div class="input-group input-group-sm">
                  <span class="input-group-text"><i class="bx bx-search"></i></span>
                  <input id="searchInput" class="form-control" placeholder="Tìm kiếm trong kết quả..." />
                </div>
              </div>
              <div class="col-md-5 col-lg-4 text-end">
                <div class="form-check form-check-inline">
                  <input id="hideZeroToggle" class="form-check-input" type="checkbox" />
                  <label class="form-check-label" for="hideZeroToggle">Ẩn Bill 0₫</label>
                </div>
              </div>
            </div>

            <div class="row g-2 align-items-center mb-3 justify-content-between">
              <div class="col-auto">
                <div class="btn-group btn-group-sm">
                  <details class="col-toggle">
                    <summary class="btn btn-outline-secondary"><i class="bx bx-show"></i> Cột</summary>
                    <div class="col-options p-2 shadow-sm">
                      <label><input type="checkbox" data-col="select" checked /> Chọn</label>
                      <label><input type="checkbox" data-col="index" checked /> STT</label>
                      <label><input type="checkbox" data-col="name" checked /> Tên KH</label>
                      <label><input type="checkbox" data-col="address" checked /> Địa chỉ</label>
                      <label><input type="checkbox" data-col="account" checked /> Mã KH</label>
                      <label><input type="checkbox" data-col="prev" /> Kỳ trước</label>
                      <label><input type="checkbox" data-col="curr" /> Kỳ này</label>
                      <label><input type="checkbox" data-col="total" checked /> Tổng cộng</label>
                      <label><input type="checkbox" data-col="nhap" checked /> Ngày nhập KHO</label>
                      <label><input type="checkbox" data-col="xuat" checked /> Ngày xuất KHO</label>
                      <label><input type="checkbox" data-col="member" checked /> Khách Hàng THẺ</label>
                      <label><input type="checkbox" data-col="employee" checked /> Nhân Viên Bán</label>
                    </div>
                  </details>

                  <button id="exportCsvBtn" class="btn btn-outline-secondary"><i class="bx bxs-file-export"></i> Xuất</button>
                  <button id="copyBtn" class="btn btn-outline-secondary"><i class="bx bx-copy"></i> Sao chép</button>
                </div>
              </div>

              <div class="col-auto">
                <div class="btn-group btn-group-sm view-toggle">
                  <button id="viewListBtn" class="btn btn-outline-secondary active" title="Danh sách"><i class="bx bx-list-ul"></i></button>
                  <button id="viewGridBtn" class="btn btn-outline-secondary" title="Lưới"><i class="bx bxs-grid"></i></button>
                </div>
              </div>
            </div>

            <div class="row g-2 align-items-center justify-content-end pagination-row">
              <div class="col-auto">
                <label for="rowsPerPage" class="col-form-label col-form-label-sm">Hiển thị</label>
              </div>
              <div class="col-auto">
                <select id="rowsPerPage" class="form-select form-select-sm">
                  <option value="15">15</option>
                  <option value="30">30</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="200">200</option>
                  <option value="999999">Tất cả</option>
                </select>
              </div>
              <div class="col-auto">
                <span id="pageInfo" class="small">Trang 1 / 1</span>
              </div>
              <div class="col-auto">
                <button id="prevPageBtn" class="btn btn-outline-secondary btn-sm"><i class="bx bx-chevron-left"></i></button>
                <button id="nextPageBtn" class="btn btn-outline-secondary btn-sm"><i class="bx bx-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </div>

        <div id="resultState" class="result-state-container d-none text-center p-4"></div>

        <div id="listContainer" class="table-responsive table-wrap shadow-sm bg-body d-none">
          <table id="resultTable" class="table table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th data-col="select"><input id="selectAllCb" type="checkbox" class="form-check-input" /></th>
                <th data-col="index" data-sort="index">STT <span class="sort-icon"></span></th>
                <th data-col="name" data-sort="text">Tên KH <span class="sort-icon"></span></th>
                <th data-col="address" data-sort="text">Địa chỉ <span class="sort-icon"></span></th>
                <th data-col="account" data-sort="text">Mã KH <span class="sort-icon"></span></th>
                <th data-col="prev" data-sort="money">Kỳ trước <span class="sort-icon"></span></th>
                <th data-col="curr" data-sort="money">Kỳ này <span class="sort-icon"></span></th>
                <th data-col="total" data-sort="money">Tổng cộng <span class="sort-icon"></span></th>
                <th data-col="nhap" data-sort="date">Ngày nhập KHO <span class="sort-icon"></span></th>
                <th data-col="xuat" data-sort="date">Ngày xuất KHO <span class="sort-icon"></span></th>
                <th data-col="member" data-sort="text">Khách Hàng THẺ <span class="sort-icon"></span></th>
                <th data-col="employee" data-sort="text">Nhân Viên Bán <span class="sort-icon"></span></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot class="table-light">
              <tr class="fw-semibold">
                <td data-col="select"></td>
                <td data-col="index" colspan="7" class="text-end">Tổng tiền (trang):</td>
                <td data-col="total" id="sumTotal">0 ₫</td>
                <td data-col="nhap"></td>
                <td data-col="xuat"></td>
                <td data-col="member"></td>
                <td data-col="employee"></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div id="gridContainer" class="grid-container d-none"></div>
      </div>

    </div>
  </main>

  <!-- Employee modal -->
  <div class="modal fade" id="employeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title">Thêm / Sửa Nhân Viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="employeeError" class="alert alert-danger d-none"></div>
          <form id="employeeForm">
            <input type="hidden" id="employeeId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label small">Tên đăng nhập</label>
                <input id="employeeUsername" class="form-control form-control-sm" required />
                <label class="form-label small mt-2">Mật khẩu</label>
                <input id="employeePassword" type="password" class="form-control form-control-sm" />
                <label class="form-label small mt-2">Quyền</label>
                <select id="employeeRole" class="form-select form-select-sm">
                  <option value="user">Nhân viên</option>
                  <option value="admin">Quản trị</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Họ và tên</label>
                <input id="employeeFullName" class="form-control form-control-sm" />
                <label class="form-label small mt-2">Số điện thoại</label>
                <input id="employeePhone" class="form-control form-control-sm" />
                <label class="form-label small mt-2">Địa chỉ</label>
                <input id="employeeAddress" class="form-control form-control-sm" />
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" form="employeeForm" class="btn btn-primary btn-sm">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes modal -->
  <div class="modal fade" id="notesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title">Ghi chú <span id="notesEmployeeName"></span></h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="notesList" class="list-group list-group-flush mb-3">
            <li class="list-group-item text-muted">Chưa có ghi chú nào.</li>
          </ul>
          <form id="addNoteForm">
            <input type="hidden" id="noteEmployeeId" />
            <textarea id="newNoteText" class="form-control mb-2" rows="3" placeholder="Nội dung ghi chú..." required></textarea>
            <button class="btn btn-success btn-sm" type="submit"><i class="bx bx-plus"></i> Thêm ghi chú</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="app.js" defer></script>

  <script>
    // Theme helper (small)
    (function () {
      const THEME_KEY = 'bs-theme';
      const set = (v) => localStorage.setItem(THEME_KEY, v);
      const get = () => localStorage.getItem(THEME_KEY) || 'auto';
      const apply = (v) => {
        let theme = v;
        if (v === 'auto') {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.setAttribute('data-bs-theme', theme);
      };
      apply(get());
      document.querySelectorAll('[data-bs-theme-value]').forEach((el) => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          const v = el.getAttribute('data-bs-theme-value');
          set(v);
          apply(v);
          document.querySelectorAll('[data-bs-theme-value].active').forEach(a => a.classList.remove('active'));
          el.classList.add('active');
        });
      });
    })();
  </script>
</body>
</html>
