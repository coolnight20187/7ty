<!DOCTYPE html>
<html lang="vi" data-bs-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra cứu & Bán Bill — CheckBill Pro</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />

  <!-- Boxicons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

  <!-- Optional app styles -->
  <link rel="stylesheet" href="style.css" />

  <meta name="description" content="Tra cứu hóa đơn điện hàng loạt, quản lý KHO, bán bill." />
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .main-container { padding: 20px 16px; max-width: 1400px; margin: 0 auto; }
    .controls-area .card { min-height: 240px; }
    .results-table { max-height: 420px; overflow:auto; }
    .btn-text { display:inline-block; }
    .spinner-border[role="status"] { width:1rem; height:1rem; }
    .fixed-footer { position: fixed; bottom: 12px; right: 12px; z-index: 1050; }
    .col-options label { display:block; margin-bottom:6px; }
    details.col-toggle summary { cursor:pointer; }
    .admin-only { display:none; }
    .table-wrap { border-radius:6px; }
    .grid-container { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:12px; }
    .card.shadow-sm { border-radius:8px; }
    .result-state-container { border:1px dashed #ddd; border-radius:8px; }
    .mt-fixed-top-space { height:78px; }
  </style>
</head>
<body class="bg-body-tertiary">

  <!-- Login modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-sm">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="bx bx-log-in-circle"></i> Đăng nhập</h5>
        </div>
        <div class="modal-body">
          <div id="loginError" class="alert alert-danger d-none"></div>
          <form id="loginForm" class="needs-validation" novalidate>
            <div class="mb-2">
              <label for="username" class="form-label">Tên đăng nhập</label>
              <input id="username" class="form-control" required />
            </div>
            <div class="mb-2">
              <label for="password" class="form-label">Mật khẩu</label>
              <input id="password" type="password" class="form-control" required />
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="rememberMeCheckbox" />
              <label class="form-check-label" for="rememberMeCheckbox">Ghi nhớ đăng nhập</label>
            </div>
            <div class="d-grid">
              <button type="submit" id="loginSubmitBtn" class="btn btn-primary d-flex align-items-center justify-content-center">
                <span class="btn-text">Đăng nhập</span>
                <div class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="loginSpinner"></div>
              </button>
            </div>
            <p class="text-muted small mt-2 text-center">Chế độ dev: bật <code>SKIP_AUTH=true</code> để bỏ qua đăng nhập</p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <nav id="appHeader" class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top d-none">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">
        <i class="bx bxs-bolt-circle text-primary"></i> Tra cứu & Bán Bill
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="usernameDisplay" class="small text-muted">—</span>
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm" id="themeBtn" data-bs-toggle="dropdown">
            <i class="bx bx-palette"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" data-bs-theme-value="light">Sáng</a></li>
            <li><a class="dropdown-item" href="#" data-bs-theme-value="dark">Tối</a></li>
            <li><a class="dropdown-item active" href="#" data-bs-theme-value="auto">Tự động</a></li>
          </ul>
        </div>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm d-flex align-items-center">
          <span class="btn-text"><i class="bx bx-log-out"></i> Thoát</span>
          <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main app -->
  <main id="appContent" class="container-fluid main-container d-none" style="padding-top:78px;">
    <div class="row g-3">

      <!-- Controls area -->
      <div class="col-12 controls-area">
        <div class="row g-3">

          <!-- Lookup -->
          <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header fw-semibold"><i class="bx bx-search-alt"></i> Tra cứu hóa đơn</div>
              <div class="card-body d-flex flex-column">
                <label for="provider" class="form-label small">Nhà cung cấp (SKU)</label>
                <select id="provider" class="form-select form-select-sm mb-2">
                  <option value="00906815">Điện lực miền Nam (00906815)</option>
                  <option value="00906819">Điện lực miền Bắc (00906819)</option>
                  <option value="00906818">Điện EVNHCMC (00906818)</option>
                  <option value="00906820">Điện EVN Hà Nội (00906820)</option>
                  <option value="00906817">Điện An Giang (00906817)</option>
                </select>

                <label for="accounts" class="form-label small">Nhập mã hợp đồng (mỗi dòng 1 mã)</label>
                <textarea id="accounts" class="form-control form-control-sm mb-2" rows="5" placeholder="Ví dụ: PB02020047317"></textarea>

                <div class="d-flex gap-2 mb-2">
                  <button id="filterDupBtn" class="btn btn-outline-secondary btn-sm flex-grow-1"><i class="bx bx-filter-alt"></i> Lọc trùng</button>
                  <button id="lookupBulkBtn" class="btn btn-primary btn-sm flex-grow-2 d-flex align-items-center justify-content-center">
                    <span class="btn-text"><i class="bx bx-search-alt"></i> Tra cứu</span>
                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
                  </button>
                </div>

                <small class="text-muted">Lưu ý: Hệ thống gọi duy nhất CheckBill Pro; không gửi quá 10 req/s</small>
              </div>
            </div>
          </div>

          <!-- KHO -->
          <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header fw-semibold"><i class="bx bx-archive"></i> KHO</div>
              <div class="card-body d-flex flex-column">
                <div class="d-grid gap-2 mb-2">
                  <button id="khoImportBtn" class="btn btn-outline-primary btn-sm"><i class="bx bx-import"></i> Nhập vào KHO</button>
                  <button id="khoRemoveBtn" class="btn btn-outline-danger btn-sm"><i class="bx bxs-trash"></i> Xóa khỏi KHO</button>
                </div>
                <hr />
                <div class="d-grid mb-2">
                  <button id="khoListBtn" class="btn btn-primary btn-sm"><i class="bx bx-box"></i> Mở KHO</button>
                </div>
                <div class="mt-auto"></div>
              </div>
            </div>
          </div>

          <!-- Employees -->
          <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header fw-semibold"><i class="bx bxs-user-detail"></i> Nhân viên</div>
              <div class="card-body d-flex flex-column">
                <div class="input-group input-group-sm mb-2">
                  <input id="employeeSearchInput" class="form-control" placeholder="Tìm nhân viên..." />
                  <button id="employeeSearchBtn" class="btn btn-outline-secondary"><i class="bx bx-search"></i></button>
                </div>
                <select id="employeeSelect" class="form-select form-select-sm mb-2" size="5"></select>
                <div class="d-flex gap-2">
                  <button id="addEmployeeBtn" class="btn btn-success btn-sm admin-only d-none" title="Thêm nhân viên"><i class="bx bx-user-plus"></i></button>
                  <button id="editEmployeeBtn" class="btn btn-warning btn-sm admin-only d-none" title="Sửa nhân viên"><i class="bx bx-edit"></i></button>
                  <button id="deleteEmployeeBtn" class="btn btn-danger btn-sm admin-only d-none" title="Xóa nhân viên"><i class="bx bx-trash"></i></button>
                </div>
                <hr />
                <button id="viewNotesBtn" class="btn btn-outline-secondary btn-sm mt-auto"><i class="bx bx-note"></i> Ghi chú NV</button>
              </div>
            </div>
          </div>

          <!-- Members & Sell -->
          <div class="col-lg-3 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header fw-semibold"><i class="bx bx-user-circle"></i> Khách Hàng Thẻ & Bán</div>
              <div class="card-body d-flex flex-column">
                <div class="d-flex gap-1 mb-2">
                  <button id="memberAddBtn" class="btn btn-outline-success btn-sm admin-only d-none"><i class="bx bx-user-plus"></i> Thêm</button>
                  <button id="memberEditBtn" class="btn btn-outline-warning btn-sm admin-only d-none"><i class="bx bx-edit"></i> Sửa</button>
                  <button id="memberViewBtn" class="btn btn-outline-info btn-sm"><i class="bx bx-list-ul"></i> Danh sách</button>
                </div>

                <input id="memberSearch" class="form-control form-control-sm mb-2" placeholder="Tìm tên KHT (Enter)" />
                <select id="memberSelect" class="form-select form-select-sm mb-3"></select>

                <label class="form-label small">Lọc Bill KHO (Từ → Đến, VNĐ)</label>
                <div class="input-group input-group-sm mb-2">
                  <span class="input-group-text">Từ</span>
                  <input id="targetFrom" class="form-control" type="number" placeholder="Số tiền" />
                  <span class="input-group-text">Đến</span>
                  <input id="targetTo" class="form-control" type="number" placeholder="Số tiền" />
                  <button id="pickBtn" class="btn btn-info"><i class="bx bx-filter"></i></button>
                </div>

                <div class="d-grid gap-2 mt-auto">
                  <button id="sellBtn" class="btn btn-success fw-bold d-flex align-items-center justify-content-center">
                    <span class="btn-text"><i class="bx bxs-check-circle"></i> Bán</span>
                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
                  </button>
                  <button id="historyBtn" class="btn btn-secondary btn-sm"><i class="bx bx-history"></i> Lịch sử giao dịch</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Results area -->
      <div class="col-12 main-content">
        <div id="status" class="alert alert-info d-none" role="alert"></div>

        <div class="card shadow-sm mb-3">
          <div class="card-body result-controls-card">
            <div class="row g-2 align-items-center mb-3">
              <div class="col-md-7 col-lg-8">
                <div class="input-group input-group-sm">
                  <span class="input-group-text"><i class="bx bx-search"></i></span>
                  <input id="searchInput" class="form-control" placeholder="Tìm kiếm trong kết quả..." />
                </div>
              </div>
              <div class="col-md-5 col-lg-4 text-end">
                <div class="form-check form-check-inline">
                  <input id="hideZeroToggle" class="form-check-input" type="checkbox" />
                  <label class="form-check-label" for="hideZeroToggle">Ẩn Bill 0₫</label>
                </div>
              </div>
            </div>

            <div class="row g-2 align-items-center mb-3 justify-content-between">
              <div class="col-auto">
                <div class="btn-group btn-group-sm">
                  <details class="col-toggle">
                    <summary class="btn btn-outline-secondary"><i class="bx bx-show"></i> Cột</summary>
                    <div class="col-options p-2 shadow-sm">
                      <label><input type="checkbox" data-col="select" checked /> Chọn</label>
                      <label><input type="checkbox" data-col="index" checked /> STT</label>
                      <label><input type="checkbox" data-col="name" checked /> Tên KH</label>
                      <label><input type="checkbox" data-col="address" checked /> Địa chỉ</label>
                      <label><input type="checkbox" data-col="account" checked /> Mã KH</label>
                      <label><input type="checkbox" data-col="prev" /> Kỳ trước</label>
                      <label><input type="checkbox" data-col="curr" /> Kỳ này</label>
                      <label><input type="checkbox" data-col="total" checked /> Tổng cộng</label>
                      <label><input type="checkbox" data-col="nhap" checked /> Ngày nhập KHO</label>
                      <label><input type="checkbox" data-col="xuat" checked /> Ngày xuất KHO</label>
                      <label><input type="checkbox" data-col="member" checked /> Khách Hàng THẺ</label>
                      <label><input type="checkbox" data-col="employee" checked /> Nhân Viên Bán</label>
                    </div>
                  </details>

                  <button id="exportCsvBtn" class="btn btn-outline-secondary"><i class="bx bxs-file-export"></i> Xuất</button>
                  <button id="copyBtn" class="btn btn-outline-secondary"><i class="bx bx-copy"></i> Sao chép</button>
                </div>
              </div>

              <div class="col-auto">
                <div class="btn-group btn-group-sm view-toggle">
                  <button id="viewListBtn" class="btn btn-outline-secondary active" title="Danh sách"><i class="bx bx-list-ul"></i></button>
                  <button id="viewGridBtn" class="btn btn-outline-secondary" title="Lưới"><i class="bx bxs-grid"></i></button>
                </div>
              </div>
            </div>

            <div class="table-responsive" style="max-height:520px;overflow:auto;">
              <table id="mainResultsTable" class="table table-hover table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width:36px"><input id="selectAllMain" type="checkbox" /></th>
                    <th>STT</th>
                    <th>Key</th>
                    <th>Account</th>
                    <th>Provider</th>
                    <th>Họ và tên</th>
                    <th>Địa chỉ</th>
                    <th class="text-end">Kỳ này</th>
                    <th class="text-end">Tổng</th>
                    <th>NhậpAt</th>
                    <th>Xóa</th>
                  </tr>
                </thead>
                <tbody id="mainResultsTbody"></tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- Small action row & pagination -->
        <div class="d-flex gap-2 mb-3">
          <button id="importAllBtn" class="btn btn-outline-primary btn-sm">Nhập tất cả vào KHO</button>
          <button id="removeSelectedBtn" class="btn btn-outline-danger btn-sm">Xóa chọn</button>
          <div class="ms-auto text-muted small" id="resultsCount">0 mục</div>
        </div>

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-center justify-content-end pagination-row">
              <div class="col-auto">
                <label for="rowsPerPage" class="col-form-label col-form-label-sm">Hiển thị</label>
              </div>
              <div class="col-auto">
                <select id="rowsPerPage" class="form-select form-select-sm">
                  <option value="15">15</option>
                  <option value="30">30</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="200">200</option>
                  <option value="999999">Tất cả</option>
                </select>
              </div>
              <div class="col-auto">
                <span id="pageInfo" class="small">Trang 1 / 1</span>
              </div>
              <div class="col-auto">
                <button id="prevPageBtn" class="btn btn-outline-secondary btn-sm"><i class="bx bx-chevron-left"></i></button>
                <button id="nextPageBtn" class="btn btn-outline-secondary btn-sm"><i class="bx bx-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </div>

        <div id="resultState" class="result-state-container d-none text-center p-4"></div>

        <div id="listContainer" class="table-responsive table-wrap shadow-sm bg-body d-none">
          <table id="resultTable" class="table table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th data-col="select"><input id="selectAllCb" type="checkbox" class="form-check-input" /></th>
                <th data-col="index" data-sort="index">STT <span class="sort-icon"></span></th>
                <th data-col="name" data-sort="text">Tên KH <span class="sort-icon"></span></th>
                <th data-col="address" data-sort="text">Địa chỉ <span class="sort-icon"></span></th>
                <th data-col="account" data-sort="text">Mã KH <span class="sort-icon"></span></th>
                <th data-col="prev" data-sort="money">Kỳ trước <span class="sort-icon"></span></th>
                <th data-col="curr" data-sort="money">Kỳ này <span class="sort-icon"></span></th>
                <th data-col="total" data-sort="money">Tổng cộng <span class="sort-icon"></span></th>
                <th data-col="nhap" data-sort="date">Ngày nhập KHO <span class="sort-icon"></span></th>
                <th data-col="xuat" data-sort="date">Ngày xuất KHO <span class="sort-icon"></span></th>
                <th data-col="member" data-sort="text">Khách Hàng THẺ <span class="sort-icon"></span></th>
                <th data-col="employee" data-sort="text">Nhân Viên Bán <span class="sort-icon"></span></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot class="table-light">
              <tr class="fw-semibold">
                <td data-col="select"></td>
                <td data-col="index" colspan="7" class="text-end">Tổng tiền (trang):</td>
                <td data-col="total" id="sumTotal">0 ₫</td>
                <td data-col="nhap"></td>
                <td data-col="xuat"></td>
                <td data-col="member"></td>
                <td data-col="employee"></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div id="gridContainer" class="grid-container d-none"></div>
      </div>
    </div>
  </main>

  <!-- Employee modal -->
  <div class="modal fade" id="employeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title">Thêm / Sửa Nhân Viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="employeeError" class="alert alert-danger d-none"></div>
          <form id="employeeForm">
            <input type="hidden" id="employeeId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label small">Tên đăng nhập</label>
                <input id="employeeUsername" class="form-control form-control-sm" required />
                <label class="form-label small mt-2">Mật khẩu</label>
                <input id="employeePassword" type="password" class="form-control form-control-sm" />
                <label class="form-label small mt-2">Quyền</label>
                <select id="employeeRole" class="form-select form-select-sm">
                  <option value="user">Nhân viên</option>
                  <option value="admin">Quản trị</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Họ và tên</label>
                <input id="employeeFullName" class="form-control form-control-sm" />
                <label class="form-label small mt-2">Số điện thoại</label>
                <input id="employeePhone" class="form-control form-control-sm" />
                <label class="form-label small mt-2">Địa chỉ</label>
                <input id="employeeAddress" class="form-control form-control-sm" />
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" form="employeeForm" class="btn btn-primary btn-sm">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes modal -->
  <div class="modal fade" id="notesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title">Ghi chú <span id="notesEmployeeName"></span></h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="notesList" class="list-group list-group-flush mb-3">
            <li class="list-group-item text-muted">Chưa có ghi chú nào.</li>
          </ul>
          <form id="addNoteForm">
            <input type="hidden" id="noteEmployeeId" />
            <textarea id="newNoteText" class="form-control mb-2" rows="3" placeholder="Nội dung ghi chú..." required></textarea>
            <button class="btn btn-success btn-sm" type="submit"><i class="bx bx-plus"></i> Thêm ghi chú</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast area -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="appToastBody">...</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Floating help / version -->
  <div class="fixed-footer">
    <button id="openHelpBtn" class="btn btn-sm btn-light shadow-sm"><i class="bx bx-info-circle"></i> Trợ giúp</button>
  </div>

  <!-- Optional libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Inline client script -->
  <script>
    // Base used by your code; keep as-is in many places for readability
    const API_BASE = '/api';

    // Redirect fetches that use API_BASE to Netlify Functions by converting '/api/kho/list' => '/.netlify/functions/kho-list'
    (function installFetchRedirect(){
      if (typeof window === 'undefined' || !window.fetch) return;
      const originalFetch = window.fetch.bind(window);
      window.fetch = function(input, init){
        try{
          if (typeof input === 'string' && input.indexOf(API_BASE + '/') === 0) {
            const path = input.slice((API_BASE + '/').length); // e.g. 'kho/list'
            const fnName = path.replace(/^\//,'').replace(/\//g,'-'); // 'kho-list'
            input = '/.netlify/functions/' + fnName;
          } else if (typeof input === 'string' && input.startsWith('/api/')) {
            const path = input.slice('/api/'.length);
            const fnName = path.replace(/^\//,'').replace(/\//g,'-');
            input = '/.netlify/functions/' + fnName;
          }
        }catch(e){
          console.warn('fetch redirect error', e);
        }
        return originalFetch(input, init);
      };
    })();

    // Small helpers and UI
    const $ = id => document.getElementById(id);
    const showToast = (msg, delay=3000) => {
      const tb = $('appToastBody');
      if(tb) tb.textContent = msg;
      if(typeof bootstrap === 'undefined') { alert(msg); return; }
      const toastEl = $('appToast');
      if(!toastEl) return;
      const t = bootstrap.Toast.getOrCreateInstance(toastEl);
      t.show();
      if(delay) setTimeout(()=>t.hide(), delay);
    };
    function fmtCurrency(v){ try{ return Number(v).toLocaleString('vi-VN') + ' ₫'; }catch{return v;} }
    function toggleSpinner(el, on=true){ const s=el.querySelector('.spinner-border'); if(!s) return; s.classList.toggle('d-none', !on); }

    // State
    let results = [], members = [], employees = [];
    let loginModal = null, khoModal = null, historyModal = null, employeeModal = null, notesModal = null;

    // Modal init and startup
    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof bootstrap !== 'undefined') {
        if ($('loginModal')) loginModal = new bootstrap.Modal($('loginModal'), { backdrop: 'static' });
        if ($('khoModal')) khoModal = new bootstrap.Modal($('khoModal'));
        if ($('historyModal')) historyModal = new bootstrap.Modal($('historyModal'));
        if ($('employeeModal')) employeeModal = new bootstrap.Modal($('employeeModal'));
        if ($('notesModal')) notesModal = new bootstrap.Modal($('notesModal'));
      } else {
        console.warn('Bootstrap is not loaded yet; modal initialization skipped.');
      }

      try{
        const h = await fetch(API_BASE + '/health');
        if(h.ok){
          const m = await fetch(API_BASE + '/members');
          if(m.status === 401){
            if(loginModal) loginModal.show(); else showToast('Yêu cầu đăng nhập');
            return;
          } else {
            initApp();
            return;
          }
        } else initApp();
      }catch(e){ initApp(); }
    });

    async function initApp(){
      $('appHeader').classList.remove('d-none'); $('appContent').classList.remove('d-none');
      bindControls(); await loadMembers(); await loadEmployees(); await loadKhoProviders(); renderMainResults();
    }

    function bindControls(){
      $('filterDupBtn').addEventListener('click', ()=>{ const lines=$('accounts').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); $('accounts').value=Array.from(new Set(lines)).join('\n'); showToast('Đã loại bỏ trùng'); });
      $('lookupBulkBtn').addEventListener('click', lookupBulk);
      $('importAllBtn').addEventListener('click', importAllResults);
      $('removeSelectedBtn').addEventListener('click', removeSelectedResults);
      $('khoListBtn').addEventListener('click', async ()=>{ await refreshKho(); if(khoModal) khoModal.show(); });
      if($('khoRefreshBtn')) $('khoRefreshBtn').addEventListener('click', async ()=>{ await refreshKho(); showToast('Đã tải KHO'); });
      $('khoImportBtn')?.addEventListener('click', importAllResults);
      $('khoRemoveBtn')?.addEventListener('click', async ()=>{ const keys=prompt('Nhập key, ngăn cách bởi dấu phẩy'); if(!keys) return; const arr=keys.split(',').map(s=>s.trim()).filter(Boolean); await fetch(API_BASE + '/kho/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({keys:arr})}); showToast('Gửi yêu cầu xóa'); });
      $('historyBtn')?.addEventListener('click', async ()=>{ await refreshHistory(); if(historyModal) historyModal.show(); });
      if($('historyRefreshBtn')) $('historyRefreshBtn').addEventListener('click', async ()=>{ await refreshHistory(); showToast('Đã tải lịch sử'); });
      if($('historyExportCsvBtn')) $('historyExportCsvBtn').addEventListener('click', ()=>{ window.location.href = API_BASE + '/history?export=csv'; });

      $('copyBtn').addEventListener('click', async ()=>{ try{ const trs=Array.from(document.querySelectorAll('#mainResultsTbody tr')); if(!trs.length){ showToast('Không có dữ liệu'); return;} const txt=trs.map(tr=>Array.from(tr.querySelectorAll('td')).map(td=>td.textContent.trim()).join('\t')).join('\n'); await navigator.clipboard.writeText(txt); showToast('Đã sao chép'); }catch(e){ showToast('Không thể sao chép'); } });

      $('exportCsvBtn').addEventListener('click', ()=>{ const cols=['stt','key','account','provider','name','address','amount_current','total','nhapAt']; const rows=results.map((r,i)=>[i+1,r.key,r.account,r.provider_id,r.name,r.address,r.amount_current,r.total,r.nhapAt||'']); const csv=[cols.join(',')].concat(rows.map(r=>r.map(c=> (c==null?'':('"'+String(c).replace(/"/g,'""')+'"'))).join(','))).join('\r\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='results.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

      $('selectAllMain')?.addEventListener('change', (e)=>{ const checked=e.target.checked; document.querySelectorAll('#mainResultsTbody input[type="checkbox"]').forEach(cb=>cb.checked=checked); });

      $('loginForm')?.addEventListener('submit', (ev)=>{ ev.preventDefault(); if(loginModal) loginModal.hide(); initApp(); showToast('Đăng nhập (tạm)'); });

      $('sellBtn')?.addEventListener('click', async (e)=>{ const btn=e.currentTarget; toggleSpinner(btn,true); try{ const memberId=$('memberSelect').value; if(!memberId){ showToast('Chọn member'); toggleSpinner(btn,false); return; } const from=Number($('targetFrom').value||0); const to=Number($('targetTo').value||0); const url=new URL(API_BASE + '/kho/list', location.origin); if(from) url.searchParams.append('fromAmount', from); if(to) url.searchParams.append('toAmount', to); const resp=await fetch(url.toString()); const arr=resp.ok?await resp.json():[]; if(!arr.length){ showToast('Không có bill'); toggleSpinner(btn,false); return; } if(!confirm('Xác nhận bán '+arr.length+' mục?')) { toggleSpinner(btn,false); return; } const keys=arr.map(x=>x.key); const s=await fetch(API_BASE + '/sell',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({member_id: memberId, keys})}); const j=await s.json(); showToast('Đã bán: '+(j.sold_count||0)); await refreshKho(); await refreshHistory(); }catch(err){console.error(err); showToast('Lỗi khi bán')} finally{ toggleSpinner(btn,false);} });

      $('employeeSearchBtn')?.addEventListener('click', ()=>{ const q=$('employeeSearchInput').value.trim().toLowerCase(); const sel=$('employeeSelect'); sel.innerHTML=''; employees.filter(e=> (e.username||'').toLowerCase().includes(q) || (e.full_name||'').toLowerCase().includes(q)).forEach(emp=>{ const opt=document.createElement('option'); opt.value=emp.id; opt.textContent=(emp.full_name||emp.username)+' • '+(emp.role||'user'); sel.appendChild(opt); }); });

      $('memberSearch')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const q=$('memberSearch').value.trim().toLowerCase(); const sel=$('memberSelect'); sel.innerHTML='<option value="">— Chọn thành viên —</option>'+members.filter(m=> (m.name||'').toLowerCase().includes(q)).map(m=>`<option value="${m.id}">${escapeHtml(m.name)}</option>`).join(''); } });

      $('openHelpBtn')?.addEventListener('click', ()=>{ alert('Trợ giúp:\n- Tra cứu -> Nhập kết quả vào KHO -> Mở KHO để quản lý -> Bán để chuyển sang Lịch sử.\n- Cấu hình API tại server, kiểm tra SKIP_AUTH cho dev.'); });
    }

    // Bulk lookup
    async function lookupBulk(){
      const btn=$('lookupBulkBtn'); toggleSpinner(btn,true);
      try{
        const sku=$('provider').value; const accounts=$('accounts').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(!accounts.length){ showToast('Nhập ít nhất 1 mã'); toggleSpinner(btn,false); return; }
        const resp=await fetch(API_BASE + '/check-electricity/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sku,contract_numbers:accounts})});
        if(!resp.ok){ const e=await resp.json().catch(()=>({error:'Upstream'})); showToast('Lỗi: '+(e.error||resp.status)); toggleSpinner(btn,false); return; }
        const data=await resp.json();
        results = data.map((r,i)=>{ const n=r.normalized||{}; return { key: n.key||`${sku}::${accounts[i]}`, ok:r.ok, account:accounts[i], provider_id:sku, name:n.name||'', address:n.address||'', amount_current: Number(n.amount_current||0), total: Number(n.total||n.amount_current||0), nhapAt: n.created_at||null, raw: r.raw||null }; });
        renderMainResults(); showToast('Tra cứu hoàn tất: '+results.length+' mục');
      }catch(e){ console.error(e); showToast('Lỗi tra cứu'); } finally{ toggleSpinner(btn,false); }
    }

    // Part 6 helpers: import/remove/render
    async function importAllResults(){
      if(!results.length){ showToast('Không có kết quả'); return; }
      const items=results.map(r=>({ key:r.key, account:r.account, provider_id:r.provider_id, name:r.name, address:r.address, amount_current:r.amount_current, total:r.total, raw:r.raw }));
      try{ const resp=await fetch(API_BASE + '/kho/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bills:items})}); const j=await resp.json(); showToast('Nhập: '+(j.count||j.added||items.length)); }catch(e){console.error(e); showToast('Lỗi import');}
    }

    function removeSelectedResults(){ const keys=Array.from(document.querySelectorAll('#mainResultsTbody input[type="checkbox"]:checked')).map(cb=>cb.dataset.key); if(!keys.length){ showToast('Chọn ít nhất 1 mục'); return;} results=results.filter(r=>!keys.includes(r.key)); renderMainResults(); showToast('Đã xóa khỏi danh sách'); }

    function renderMainResults(){
      const tbody=$('mainResultsTbody'); if(!tbody) return; tbody.innerHTML=''; const q=$('searchInput')?$('searchInput').value.trim().toLowerCase():''; const hideZero=$('hideZeroToggle')?$('hideZeroToggle').checked:false;
      const visible=results.filter((r)=>{ if(hideZero && (Number(r.total||r.amount_current||0)===0)) return false; if(!q) return true; return ((r.name||'')+' '+(r.address||'')+' '+(r.account||'')+' '+(r.key||'')).toLowerCase().includes(q); });
      visible.forEach((r,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="checkbox" data-key="${escapeHtml(r.key)}"></td><td>${idx+1}</td><td>${escapeHtml(r.key)}</td><td>${escapeHtml(r.account)}</td><td>${escapeHtml(r.provider_id)}</td><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.address)}</td><td class="text-end">${fmtCurrency(r.amount_current||r.total)}</td><td class="text-end">${fmtCurrency(r.total||r.amount_current)}</td><td>${r.nhapAt?new Date(r.nhapAt).toLocaleString():''}</td><td><button class="btn btn-sm btn-danger row-remove" data-key="${escapeHtml(r.key)}"><i class="bx bx-trash"></i></button></td>`; tbody.appendChild(tr); });
      document.querySelectorAll('.row-remove').forEach(b=>b.addEventListener('click', e=>{ const k=e.currentTarget.dataset.key; results=results.filter(x=>x.key!==k); renderMainResults(); showToast('Đã xóa'); }));
      const countEl = $('resultsCount'); if(countEl) countEl.textContent = visible.length+' mục (tổng '+results.length+')';
      updateSum();
    }

    function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function loadMembers(){ try{ const resp=await fetch(API_BASE + '/members'); if(!resp.ok) return; members=await resp.json(); const sel=$('memberSelect'); if(sel) sel.innerHTML='<option value="">— Chọn thành viên —</option>'+members.map(m=>`<option value="${m.id}">${escapeHtml(m.name)}</option>`).join(''); }catch(e){console.error('loadMembers',e);} }

    async function loadEmployees(){ try{ const resp=await fetch(API_BASE + '/members'); if(resp.ok){ employees=[]; document.querySelectorAll('.admin-only').forEach(el=>el.classList.remove('d-none')); } }catch(e){console.error(e);} }

    async function loadKhoProviders(){ try{ const resp=await fetch(API_BASE + '/kho/list'); if(!resp.ok) return; const arr=await resp.json(); const providers=Array.from(new Set(arr.map(r=>r.provider_id))).filter(Boolean).sort(); const sel=$('khoProviderFilter'); if(sel) sel.innerHTML='<option value="">— Tất cả nhà cung cấp —</option>'+providers.map(p=>`<option value="${p}">${p}</option>`).join(''); }catch(e){console.error('loadKhoProviders',e);} }

    async function refreshKho(){ try{ const q=$('khoSearch')?$('khoSearch').value.trim():''; const provider=$('khoProviderFilter')?$('khoProviderFilter').value:''; const url=new URL(API_BASE + '/kho/list', location.origin); if(q) url.searchParams.append('search',q); if(provider) url.searchParams.append('provider_id',provider); const resp=await fetch(url.toString()); if(!resp.ok){ showToast('Không thể tải KHO'); return []; } const arr=await resp.json(); const tbody=$('khoTbody'); if(!tbody) return arr; tbody.innerHTML=''; arr.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="checkbox" data-key="${escapeHtml(r.key)}"></td><td>${escapeHtml(r.key)}</td><td>${escapeHtml(r.account)}</td><td>${escapeHtml(r.provider_id)}</td><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.address)}</td><td class="text-end">${fmtCurrency(r.total)}</td><td>${r.nhapAt?new Date(r.nhapAt).toLocaleString():''}</td><td><button class="btn btn-outline-danger btn-sm kho-delete" data-key="${escapeHtml(r.key)}"><i class="bx bx-trash"></i></button></td>`; tbody.appendChild(tr); }); document.querySelectorAll('.kho-delete').forEach(btn=>btn.addEventListener('click', async e=>{ const key=e.currentTarget.dataset.key; if(!confirm('Xóa key '+key+' ?')) return; try{ const resp=await fetch(API_BASE + '/kho/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({keys:[key]})}); const j=await resp.json(); showToast('Đã xóa: '+(j.removed||1)); await refreshKho(); }catch(err){console.error(err); showToast('Lỗi xóa'); } })); return arr; }catch(e){console.error('refreshKho',e); showToast('Lỗi tải KHO'); return []; } }

    async function refreshHistory(){ try{ const resp=await fetch(API_BASE + '/history?limit=200'); if(!resp.ok){ showToast('Không thể tải lịch sử'); return []; } const arr=await resp.json(); const tbody=$('historyTbody'); if(!tbody) return arr; tbody.innerHTML=''; arr.forEach(h=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${h.id}</td><td>${escapeHtml(h.key)}</td><td>${escapeHtml(h.account)}</td><td>${escapeHtml(h.provider_id)}</td><td>${escapeHtml(h.name)}</td><td>${escapeHtml(h.member_name||'')}</td><td class="text-end">${fmtCurrency(h.total)}</td><td>${h.soldAt?new Date(h.soldAt).toLocaleString():''}</td>`; tbody.appendChild(tr); }); return arr; }catch(e){console.error('refreshHistory',e); showToast('Lỗi tải lịch sử'); return []; } }

    function updateSum(){
      const sum = results.reduce((s,r)=>s + (Number(r.total)||0), 0);
      const el = $('sumTotal');
      if(el) el.textContent = fmtCurrency(sum);
    }

    // Graceful offline ping
    (async ()=>{
      try {
        const h = await fetch(API_BASE + '/health');
        if(!h.ok) console.warn('API health not ok');
      } catch(e){
        console.warn('API not available, running in offline mode');
      }
    })();

  </script>
</body>
</html>
